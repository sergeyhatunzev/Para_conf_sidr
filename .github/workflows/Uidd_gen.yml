name: Generate & Test VLESS Configs (UUID Generator)

on:
  workflow_dispatch:  # Запуск вручную через кнопку "Run workflow"

jobs:
  generate-vless:
    runs-on: ubuntu-latest

    steps:
      # 1. Чекаем репозиторий
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Устанавливаем Python 3.11
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 3. Устанавливаем все зависимости Python
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install rich requests urllib3 icmplib psutil

      # 4. Скачиваем последнюю версию Xray-core (Linux amd64)
      - name: Download Xray-core
        run: |
          LATEST_VERSION=$(curl -s https://api.github.com/repos/XTLS/Xray-core/releases/latest | grep tag_name | cut -d '"' -f 4)
          echo "Latest Xray version: $LATEST_VERSION"
          curl -L -o xray.zip "https://github.com/XTLS/Xray-core/releases/download/$LATEST_VERSION/Xray-linux-64.zip"
          unzip xray.zip xray
          chmod +x xray
          ./xray --version

      # 5. Проверяем наличие входного файла
      - name: Check input file exists
        run: |
          if [ ! -f "sidr_vless.txt" ]; then
            echo "ERROR: sidr_vless.txt not found in repository!"
            exit 1
          fi
          echo "Input file found. Lines count:"
          wc -l sidr_vless.txt

      # 6. Запускаем скрипт
      - name: Run UUID Generator & Tester
        run: python Uidd_gen_work.py
        env:
          PYTHONUNBUFFERED: "1"

      # 7. Проверяем выходной файл
      - name: Check output file
        run: |
          if [ -f "Wow_work_uidd.txt" ]; then
            echo "Output file created successfully!"
            wc -l Wow_work_uidd.txt
            head -n 10 Wow_work_uidd.txt || true
          else
            echo "ERROR: Wow_work_uidd.txt was not created!"
            exit 1
          fi

      # 8. Загружаем результат как артефакт
      - name: Upload working configs as artifact
        uses: actions/upload-artifact@v4
        with:
          name: working-vless-configs
          path: Wow_work_uidd.txt
          if-no-files-found: warn
          retention-days: 7
